<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Simplex KKT Interativo</title>
<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f7f9fb; }
table { border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #999; padding:5px; text-align:center; }
th { background:#eee; }
input { width:60px; text-align:center; }
button { padding:6px 10px; margin:5px; }
.status { margin-top:10px; padding:8px; border-radius:5px; }
.ok { background:#dcfce7; color:#065f46; }
.error { background:#fee2e2; color:#9b1c1c; }
</style>
</head>
<body>

<h1>Simplex KKT - Quadrático Interativo</h1>

<label>Nome do aluno: <input id="studentName" type="text"></label>

<div id="inputCard" class="card" style="margin-top:10px;">
  <div class="small">Informe os coeficientes da função objetivo (maximizar):</div>
  <div class="row" style="margin-top:8px">
    <label>coef x1²: <input id="c_x1sq" type="number" step="any" value="-1"></label>
    <label>coef x2²: <input id="c_x2sq" type="number" step="any" value="-2"></label>
    <label>coef x1x2: <input id="c_x1x2" type="number" step="any" value="0"></label>
    <label>coef x1: <input id="c_x1" type="number" step="any" value="6"></label>
    <label>coef x2: <input id="c_x2" type="number" step="any" value="8"></label>
  </div>

  <div style="margin-top:10px" class="small">Restrição linear (<=):</div>
  <div class="row" style="margin-top:8px">
    <label>a1 (x1): <input id="a1" type="number" step="any" value="2"></label>
    <label>a2 (x2): <input id="a2" type="number" step="any" value="4"></label>
    <label>b: <input id="b" type="number" step="any" value="8"></label>
  </div>

  <div style="margin-top:12px" class="small">
    Observação: as restrições x1≥0, x2≥0 são implícitas. O aluno só altera os coeficientes acima.
  </div>
</div>

<br>
<button id="start">Iniciar Iterações</button>
<div id="iterationsArea"></div>
<div class="status" id="feedback">Clique em "Iniciar Iterações" para preencher passo a passo.</div>
<div class="status" id="scoreStatus"></div>

<script>
const varNames = ['x1','x2','x3','y1','y2','y3'];
let autoIterations = [];
let currentIter = 0;
let base=[], A=[], b=[];
let studentName = "";
let score = 100, totalChecks = 0;

// --- Monta problema a partir dos inputs ---
function montarProblema() {
  let c_x1sq = parseFloat(document.getElementById('c_x1sq').value);
  let c_x2sq = parseFloat(document.getElementById('c_x2sq').value);
  let c_x1   = parseFloat(document.getElementById('c_x1').value);
  let c_x2   = parseFloat(document.getElementById('c_x2').value);
  let c_x1x2 = parseFloat(document.getElementById('c_x1x2').value);

  let a1 = parseFloat(document.getElementById('a1').value);
  let a2 = parseFloat(document.getElementById('a2').value);
  let bb = parseFloat(document.getElementById('b').value);

  let A_local = [
    [a1, a2, 1, 0, 0, 0],
    [2* c_x1sq, c_x1x2, 0, 1, 0, -a1],
    [0, 2*c_x2sq, 0, 0, 1, -a2]
  ];

  let b_local = [bb, -c_x1, -c_x2];

  return {A:A_local, b:b_local};
}

// --- Pivotamento e lógica Simplex ---
function saveAutoIteration(){
  autoIterations.push({
    base:[...base],
    A:A.map(r=>[...r]),
    b:[...b]
  });
}

function pivot(row,col){
  const pivotVal = A[row][col];
  for(let j=0;j<A[row].length;j++) A[row][j]/=pivotVal;
  b[row]/=pivotVal;
  for(let i=0;i<A.length;i++){
    if(i===row) continue;
    const factor = A[i][col];
    for(let j=0;j<A[i].length;j++) A[i][j] -= factor*A[row][j];
    b[i] -= factor*b[row];
  }
  base[row] = varNames[col];
  saveAutoIteration();
}

function enteringVar(){
  let minVal=0,row=-1;
  for(let i=0;i<b.length;i++){
    if(b[i]<minVal){ minVal=b[i]; row=i;}
  }
  if(row===-1) return null;
  const leaveVar = base[row];
  const enterVar = leaveVar.startsWith('x') ? 'y'+leaveVar.slice(1) : 'x'+leaveVar.slice(1);
  const col = varNames.indexOf(enterVar);
  return {row,col};
}

function isOptimal(){ return b.every(v=>v>=0); }

function solveAutomatic(problem){
  base=['x3','y1','y2'];
  A=problem.A.map(r=>[...r]);
  b=problem.b.map(v=>v);
  autoIterations=[];
  saveAutoIteration();
  while(!isOptimal()){
    const pv = enteringVar();
    if(!pv) break;
    pivot(pv.row,pv.col);
  }
}

// --- Renderização ---
function renderStudentIteration(iterIdx){
  const area = document.getElementById('iterationsArea');

  // Mantém o tableau anterior visível
  if(iterIdx>0){
    const prev = autoIterations[iterIdx-1];
    let html = `<h4>Iteração ${iterIdx} (anterior para referência)</h4><table><tr><th>Base</th>${varNames.map(v=>`<th>${v}</th>`).join('')}<th>b</th></tr>`;
    for(let r=0;r<prev.base.length;r++){
      html += `<tr><td>${prev.base[r]}</td>`;
      for(let j=0;j<varNames.length;j++) html += `<td>${prev.A[r][j].toFixed(2)}</td>`;
      html += `<td>${prev.b[r].toFixed(2)}</td></tr>`;
    }
    html += "</table>";
    area.innerHTML = html;
  } else {
    area.innerHTML = "";
  }

  // Formulário para próxima iteração
  area.innerHTML += `<h4>Preencha a iteração ${iterIdx+1}:</h4><table><tr><th>Base</th>${varNames.map(v=>`<th>${v}</th>`).join('')}<th>b</th></tr>`;
  for(let r=0;r<base.length;r++){
    area.innerHTML += `<tr><td><input type="text" id="base_${r}" placeholder="${base[r]}"></td>`+
      varNames.map((v,j)=>`<td><input type="number" step="0.01" id="cell_${r}_${j}"></td>`).join('')+
      `<td><input type="number" step="0.01" id="b_${r}"></td></tr>`;
  }
  area.innerHTML += `</table><button onclick="checkIteration()">Verificar</button>`;
  document.getElementById("scoreStatus").innerText = `Pontuação: ${score}`;
}

// --- Verificação e nota ---
function checkIteration(){
  const it = autoIterations[currentIter];
  let correct = true;

  for(let r=0;r<it.base.length;r++){
    let studentBase = document.getElementById(`base_${r}`).value.trim();
    if(studentBase!==it.base[r]) correct=false;
    for(let j=0;j<varNames.length;j++){
      let val = parseFloat(document.getElementById(`cell_${r}_${j}`).value);
      if(Math.abs(val - it.A[r][j])>1e-4) correct=false;
    }
    let bv = parseFloat(document.getElementById(`b_${r}`).value);
    if(Math.abs(bv - it.b[r])>1e-4) correct=false;
  }

  if(correct){
    currentIter++;
    document.getElementById('feedback').innerText = "✅ Iteração correta!";
    document.getElementById('feedback').className = "status ok";
    renderStudentIteration(currentIter);
  } else {
    score -= 5;
    document.getElementById('feedback').innerText = "❌ Iteração incorreta, tente novamente!";
    document.getElementById('feedback').className = "status error";
    document.getElementById("scoreStatus").
